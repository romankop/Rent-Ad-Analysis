---
title: "Обзор объявлений о сдаче квартир в Санкт-Петербурге и Ленинградской области"
output: 
  rmdformats::material
author: 'Авилов Илья, Копыл Роман, Степан Малых'
date: '24.04.2020'
---

<style>

.menu ul li a {
  color: #000000;
}

.menu ul li.active {
  background-color: #FD6467;
  color: #FFFFFF;
  position: relative;
}

.menu ul li.active a {
  color: #FFFFFF;
}

.nav {
  background-color: #EAD3BF;
  color: #FFFFFF;
}


body {
  background-color: #F1BB7B;
}


.header-panel {
  background-color: #79402E;
}

.pages h1 {
  color: #5B1A18;
}

.pages h2 {
  color: #DC863B;
}

.pages h3 {
  color: #DC863B;
}

</style>
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(Hmisc)
library(picante)
library(RColorBrewer)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(dplyr)
library(qwraps2)
library(stringr)
library(moments)
library(DescTools)
library(knitr)
library(stringi)
library(tidyr)
library(prettydoc)
library(DT)
library(scales)
library(kableExtra)
library(corrplot)
library(DescTools)
library(gtools)
library(gridExtra)
```

```{r}
Darjeeling <- colorRampPalette(wes_palette("Darjeeling1"))
GrandBudapest <- colorRampPalette(wes_palette("GrandBudapest1"))
Moonrise <- colorRampPalette(wes_palette("Moonrise1"))
FantasticFox <- colorRampPalette(wes_palette("FantasticFox1"))
Royal1 <- colorRampPalette(wes_palette("Royal1"))
Rushmore1 <- colorRampPalette(wes_palette("Rushmore1"))

```


```{r}
data = read.csv('SPb_dwellings_for_rent_EMLS_sample_1.csv', sep = ',', na.strings = '')
```


# Вводные данные

У нас есть данные о 3000 объявлениях по сдаче квартир в Санкт-Петербурге и Ленинградской области.

Перед тем как провести разведывательный анализ данных мы проведем их очистку от технических ошибок и приведем к удобному формату:\
1. В данных об этажах имеются лишние символы, мы их удалим\
2. Уберем единицы измерения из данных о минимальном сроке аренды\
3. Удалим те объявления, в которых общая площадь меньше, чем сумма жилой площади и площади кухни\
4. Переведем цену от руб/мес к тыс.руб./мес.\
5. Для удобства работы избавимся от транслита и приведем слова, написанные транслитом,  к кириллице.\
6. Также заменим пропуски в данных на "Нет данных"

```{r}
nominal_vars = c("Date_entry", "Region", "District_ad", "Address", "Metro", "No_agents", "Building", "Lift", "Furnished", "Bath", "Refurbished", "Balcony", "Rooms")

num_vars = c("Price", "Dist_metro_ad", "Minimum_duration", "Area_total", "Area_living", "Area_kitchen", "Floor", "NFloor", "Latitude", "Longitude", "Year_construction")
```


```{r}
## Лишние символы в этажах
data$NFloor = str_replace(data$NFloor, 'kv.m.', '')
data$NFloor = str_replace(data$NFloor, '\\.', '')
data$NFloor = str_replace(data$NFloor, ' ', '')
data$NFloor = as.numeric(data$NFloor)

## Площадь
data = data %>% filter((Area_total >= (Area_kitchen + Area_living)) & (Area_total>Area_kitchen) & (Area_total>Area_living) )


## Удаляем единицы измерения из колонки Minimum_duration и приводим к нужному типу данных
data$Minimum_duration = str_replace(data$Minimum_duration, ' mes.', '')
data$Minimum_duration = as.numeric(data$Minimum_duration)


## Приведем к тыс.руб./мес

data$Price = data$Price/1000

##Заменяем транслит на кириллицу
data$Region = stri_trans_general(data$Region, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Metro = stri_trans_general(data$Metro, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Metro = replace_na(as.character(data$Metro), 'Нет данных')
data$Metro = str_replace_all(data$Metro, 'j', 'ж')
data$Metro = str_replace_all(data$Metro, 'h', 'х')
data$Metro = str_replace_all(data$Metro, 'Сестрореcк', 'Сестрорецк')
data$Metro = str_replace_all(data$Metro, 'Cарское село', 'Царское село')
data$Building = stri_trans_general(data$Building, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Building= str_replace_all(data$Building, 'j', 'ж')
data$Building= str_replace_all(data$Building, 'h', 'х')
data$Building= str_replace_all(data$Building, 'Реконструксия', 'Реконструкция')
data$Building = replace_na(as.character(data$Building), 'Нет данных')
data$Lift = stri_trans_general(data$Lift, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Lift = str_replace_all(data$Lift, 'Эсть', 'Есть')
data$Furnished = stri_trans_general(data$Furnished, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Furnished = str_replace_all(data$Furnished, 'h', 'х')
data$Furnished = replace_na(as.character(data$Furnished), 'Нет данных')
data$Bath = stri_trans_general(data$Bath, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Bath = replace_na(as.character(data$Bath), 'Нет данных')
data$Refurbished = stri_trans_general(data$Refurbished, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Refurbished = str_replace_all(data$Refurbished, 'Эвростандарт', 'Евро стандарт')
data$Refurbished = str_replace_all(data$Refurbished, 'ця', 'тся')
data$Refurbished = replace_na(as.character(data$Refurbished), 'Нет данных')
data$Balcony = stri_trans_general(data$Balcony, "latin-russian/bgn") %>% str_replace_all("'", 'ь')
data$Balcony= str_replace_all(data$Balcony, 'j', 'ж')
data$Balcony = replace_na(as.character(data$Balcony), 'Нет данных')
data$No_agents = str_replace_all(data$No_agents, 'Da', 'Без агента')
data$No_agents = replace_na(as.character(data$No_agents), 'С агентом')

## Заменим кол-во комнат в студиях на 0
data$Rooms = str_replace_all(data$Rooms, '1 \\(studiya\\)', '0')
data$Rooms = as.numeric(data$Rooms)

``` 


После удаления наблюдений с техническими ошибками в нашем датасете осталось 2435 наблюдений.\

Далее построим таблицы со статистиками для номинальных и числовых переменных.\

Затем при подсчете всех статистик мы исключали пропущенные значения\


# Частоты номинальных переменных

Номинальные переменные: \
1. Дата\
2. Регион\
3. Район\
4. Адрес\
5. Метро\
6. Сделка с агентом или без\
7. Тип здания\
8. Наличие лифта\
9. Наличие мебели\
10. Тип ремонта\
11. Балкон.\

Количество комнат мы сделали ординальной переменной. Сделать числовой нельзя, потому что есть квартиры студии - в которых количество комнат строго не определено(с одной стороны комната 1, а с другой стороны это студия). При этом это также не номинальная переменная, потому что мы можем сравнить студию, однокомнатную квартиру и тд по количеству комнат(студия<1комнатная<двухкомнатная).\

Далее мы построим таблицы частот встречаемости различных наблюдений для каждой номинальной переменной

```{r}
table_region = data %>% group_by(Region) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_disctrict = data %>% group_by(District_ad) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_metro = data %>% group_by(Metro) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_agents = data %>% group_by(No_agents) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_building = data %>% group_by(Building) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_lift = data %>% group_by(Lift) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_furnished = data %>% group_by(Furnished) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_bath = data %>% group_by(Bath) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_refurbished = data %>% group_by(Refurbished) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_balcony = data %>% group_by(Balcony) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
table_rooms = data %>% group_by(Rooms) %>% summarise("Количество наблюдений" = n()) %>% arrange(desc(!!(sym("Количество наблюдений")))) 
```


## Регион

```{r}
kable(table_region) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

Большинство квартир из объявлений расположены в Петербурге. Так происходит, потому что в городе живет гораздо больше людей, чем в области.

## Район

```{r}
d = table_disctrict
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

Как видно, большая часть квартир распологается в городских районах, в то время как в различных районах ЛО расположена лишь небольшая часть квартир. Причина таже - в городе просто больше людей и квартир.

## Станция метро

```{r}
d = table_metro
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

Много квартир расположено рядом со станциями метро Приморская и Комендантский проспект. Это можно объяснить тем, что рядом с этими станциями метро много относительно новых, многоэтажных зданий, следовательно плотность недвижимости там больше.\

Также можно заметить, что в этом списке есть несуществующие станции метро: Репино, Павловск и тд. Это все железнодорожные станции. Мы не будем удалять эти наблюдения как ошибочные, а лишь оставим примечания, что содержатся наблюдения, в которых вместо станции метро указана железнодорожная станция.

## Тип здания

```{r}
d = table_building
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

Большая часть квартир расположена в домах относительно современного типа: кирпичные, кирпично-монолитные, панельные и тд. Также в наблюдениях присутствуют квартиры в домах старого жилового фонда, "сталинках" и тд., но их доля невелика.

## Наличие лифта

```{r}
kable(table_lift) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```


Более чем в половине домов присутствуют лифты, но в ~40% домов они отсутствуют. Это может быть связано с тем, что в выборке прсутствует множество квартир либо из домов малой этажности, либо из старых домов, в которых лифтов нет.

## Количество комнат в квартире

```{r}
d = table_rooms
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

Самые популярные квартиры - однокомнатные. Следующие по популярности двухкомнатные. Студии не часто встречаются в объявлениях. Возможно, что наша выборка смещена(то есть в ней просто мало квартир-студий), либо люди, продающие студии, отмечают свои квартиры как 1-комнатные.

## Наличие мебели

```{r}
d = table_furnished
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

В большинстве наблюдений нет данных о наличие мебели в квартире. Однако во многих объявлениях указано, что квартира оснащена современной мебелью. Лишь в нескольких десятках объявлениях указано, что мебель старая.

## Ванная комната

```{r}
kable(table_bath) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```


Как и с данными о мебели - в большинстве объявлений не указан тип ванной комнаты. В большой части квартир указана отдельная ванная и примерно в 300 наблюдениях сказано о совмещенном сан.узле и ванной комнате. В незначительном количестве объявлений указано положение ванны - продольная или поперечная.

## Ремонт

```{r}
kable(table_refurbished) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

Около 1000 наблюдений не имеет данных о ремонте в квартире. Также большая часть сообщает о выполненном ремонте или отсутствии неоходимости его выполнения. Лишь в 9 наблюдениях сказано о необходимости ремонта. Это может быть связано с тем, что люди не хотят отпугнуть арендатора необходимостью ремонта.

## Балкон

```{r}
d = table_balcony
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

Как и в предыдущих случаях, большинство наблюдений не содержат данных о наличие балкона. При этом следующими по частоте встречаемости являются вартиры с балконами и лоджиями. Лишь несколько десятков объявлений сообщают о наличии нескольких балконов/лоджий. Еще меньше квартир с террасами/эркерами, т.к. они нетипичны для большинства домов в Петербурге и ЛО.

## Сделка с агентом или без

```{r}
kable(table_agents) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```


Большая часть объявлений сообщают о сдаче через посредника. Это может быть обусловленно тем, что люди либо хотят обезопасить себя, привлекая квалифицированную сторону, либо не хотят тратить свое время и силы  на сдачу квартир.

# Статистики числовых переменных

Числовые переменные: 

```{r}
library(xtable)
data_num = data[num_vars]
range_udf = function(x, na.rm=TRUE) {
  return(max(x,na.rm = na.rm)-min(x, na.rm = na.rm))
}


num_stats = do.call(data.frame,
          list(
            "Среднее" = apply(data_num, 2, mean, na.rm=TRUE),
            "Медиана" = apply(data_num, 2, median, na.rm=TRUE),
            "Мода" = apply(data_num, 2, Mode, na.rm=TRUE),
            "Квартиль1" = apply(data_num, 2, quantile, 0.25, na.rm=TRUE),
            "Квартиль3" = apply(data_num, 2, quantile, 0.75, na.rm=TRUE),
            "Станд.отклон." = apply(data_num, 2, sd, na.rm=TRUE),
            "Размах" = apply(data_num, 2, range_udf, na.rm=TRUE),
            "Минимум" = apply(data_num, 2, min, na.rm=TRUE),
            "Максимум" = apply(data_num, 2, max, na.rm=TRUE),
            "Куртозис" = apply(data_num, 2, kurtosis, na.rm=TRUE),
            "Ассиметрия" = apply(data_num, 2, skewness, na.rm=TRUE)
          ))

rownames(num_stats) = c('Цена', 'Дист. до метро, м', 'Мин. срок аренды', 'Общ. площ.', 'Жил. площ.', 'Площ. кухн.', 'Кол-во этажей в доме', 'Номер этажа', 'Широта', 'Долгота', 'Год постройки дома')


rounding = function(x){
  if(abs(x)<1){
    x = round(x, 3)
  } 
  else if(abs(x)<10){
    x = round(x, 2)
  }
  else if(abs(x)<100){
    x = round(x, 1)
  }
  else {
    x = round(x, 0)
  }
  return(x)
}



for (col in colnames(num_stats)){
  num_stats[, col] = sapply(num_stats[, col], rounding)
}



kable(num_stats) %>% 
  kable_styling(bootstrap_options = c('condensed'), full_width = F, font_size = 15) %>%
  scroll_box(width = "100%", height = "600px")
```


С помощью данной таблицы попытаемся обнаружить ошибочные наблюдения. Если имеется слишком большое стандартное отклонение, большой куртозис и максимальное(минимальное) значение сильно отличается от 3(1) квартиля, то мы будем искать в данных ошибку.

## Цена
Начнем с максимальных цен на квартиры. Рассмотрим 4 самых дорогие квартиры.

```{r}
data %>% top_n(4, Price) %>% select(District_ad, Address, Area_total, Area_living, Price, Longitude, Latitude) %>% kable(caption = "4 самые дорогие квартиры") %>% kable_styling(bootstrap_options = c('condensed'), full_width = F) %>%
  scroll_box(width = "100%")
```

Аренда квартиры в Петроградском и Адмиралтейском районах вполне могут стоить таких денег, потому что это престижные части города. Однако, квартиры в Приморском районе так дорого обыычно не стоят. Рассмотрев подробнее два этих наблюдения выясняется, что адреса Приморское шоссе 412 в Лисем Носу вообще нет. По координатам квартиры с Главной улицы за 450 тыс.руб в месяц раньше находился гаражный кооператив, который на данный момент снесен. Квартиры с общей площадью 600 кв.м из которых 130 кв.м - жилые, там быть явно не могло. Удалим эти 2 наблюдения как ошибочные.

Рассмотрим минимальные цены на квартиры:
```{r}
data %>% top_n(12, -Price) %>% arrange(Price) %>% select(Date_entry, District_ad, Dist_metro_ad, Area_total, Area_living, Price) %>% kable(caption = 'Самые дешевые квартиры') %>% kable_styling(bootstrap_options = c('condensed'), full_width = F) %>%
  scroll_box(width = "100%", height = "400px")
```

Есть несколько квартир, стоимость аренды которых в месяц меньше 10 тыс.руб/мес. Даже в 2016 году вряд ли в Петербурге были квартиры с такой площадью за столь малые деньги. Поэтому мы удалим данные наблюдения как ошибочные

## Расстояния до ближайшей станции метро (метры)

```{r}
data %>% top_n(4, Dist_metro_ad) %>% arrange(Dist_metro_ad) %>% select(Metro, District_ad, Address, Dist_metro_ad) %>% kable(caption = 'Самые далекие от метро квартиры') %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

Проверив расстояние до ближайшей станции метро в яндекс картах, можно убедиться, что эти расстояния не ошибочны.

Теперь рассмотрим самые близкие к метро квартиры.

```{r}
data %>% filter(Dist_metro_ad == 0) %>% head(4) %>% select(District_ad, Address, Dist_metro_ad) %>% kable(capture = 'Самыые близкие к метро квартиры') %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```


Есть несколько наблюдений, в которых расстояние до метро равно нулю. Такого, конечно же, быть не может, поэтому мы удалим эти наблюдения как ошибочные.\
Тут стоит отметить, что все люди пытаются сдать свои квартиры как можно быстрее и как можно дороже, поэтому, чтобы выделить свою квартиру среди остальных, люди идут на некоторые ухищрения. Например, занижают расстояние до ближайшей станции метро. В наших данных также наблюдается такая тенденция, поэтому к использованию данных о расстоянии до метро нужно подходить внимательно. 

## Минимальный срок аренды квартиры

Максимальное значение минимального срока аренды квартир в 3 раза больше 3 квартиля, то есть распределение сильно скошено вправо. Проверим наблюдения с большим минимальным сроком аренды.

```{r}
d = data %>% top_n(1, Minimum_duration) %>% select(Address, Price, Minimum_duration)
dt <- datatable(d, filter = 'bottom', options = list(pageLength = 5)) 
dt
```

В нашей выборке существуют люди, которые хотят сдать квартиру минимум на 31 месяц и минимум на 14 месяцев, но при этом нет людей, которые хотели бы сдать квартиры, например, на 20 месяцев. Тем не менее, мы не будем удалять наблюдения с минимальным сроком аренды в 31 месяц, потому что возможно, что в нашу выборку не попали наблюдения, срок минимальный срок аренды которых находится между 14 и 31 месяцами.

Наблюдения с маленьким минимальным сроком аренды мы не будем рассматривать как ошибочные, т.к. люди вполне могут хотеть сдать квартиру хоть на какой-то срок(даже 1 месяц).


## Общая площадь

Куртозис данных очень большой, а также максимальное значение сильно больше 3 квартиля, скорее всего в данных имеется либо выброс, либо ошибка. Проверим квартиру с самой большой общей площадью.

```{r}
data %>% top_n(1, Area_total) %>% select(Address, Rooms, Price, Area_living, Area_kitchen, Area_total) %>% kable() %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```
В квартире 2 комнаты и жилая площадь всего 22 кв. метров, но при этом общая площадь 23 000 кв.метров. Такая площадь ошибочна, так что мы удалим данное наблюдение

```{r}
data %>% top_n(3, -Area_total) %>% select(Address, Rooms, Price, Area_living, Area_kitchen, Area_total) %>% kable() %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

## Жилая площадь

```{r}
data %>% top_n(3, Area_living) %>% select(Address, Rooms, Price, Area_total, Area_kitchen, Area_living) %>% kable() %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

Данные квартиры стоят дорого, в них много комнат, следовательно и жилая площадь большая, так что скорее всего эти наблюдения не ошибочны.

```{r}
data %>% top_n(3, -Area_living) %>% select(Address, Rooms, Price, Area_total, Area_kitchen, Area_living) %>% kable() %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

В наблюдениях с минимальной жилой площадью на наш взгляд также нет ошибки. Квартира с 2 кв. метрами жилой площади безусловно является нетипичной для нашей выборке, однако судить наверняка об ошибочности данного наблюдения мы не может


## Площадь кухни

```{r}
data %>% top_n(5, Area_kitchen) %>% select(Address, Rooms, Price, Area_living, Area_total, Area_kitchen) %>% kable() %>% kable_styling(bootstrap_options = c('condensed'), full_width = F)
```

Квартиры стоят дорого, общая площадь в них большая, поэтому мы не будем удалять эти наблюдения как ошибочные.


```{r}
data = data %>% filter((Address != 'Главная ул.') & (Address != 'Лисий Нос, Приморское шоссе, 412') &
                       (Price>=10) &
                       (Dist_metro_ad != 0) &
                       (Area_total != 23000) &
                       (Area_kitchen<=Area_living)
)
```

## Статистики числовых переменных после удаления ошибочных наблюдений

```{r}
data_num = data[num_vars]
range_udf = function(x, na.rm=TRUE) {
  return(max(x,na.rm = na.rm)-min(x, na.rm = na.rm))
}


num_stats = do.call(data.frame,
          list(
            "Среднее" = apply(data_num, 2, mean, na.rm=TRUE),
            "Медиана" = apply(data_num, 2, median, na.rm=TRUE),
            "Мода" = apply(data_num, 2, Mode, na.rm=TRUE),
            "Квартиль1" = apply(data_num, 2, quantile, 0.25, na.rm=TRUE),
            "Квартиль3" = apply(data_num, 2, quantile, 0.75, na.rm=TRUE),
            "Станд.отклон." = apply(data_num, 2, sd, na.rm=TRUE),
            "Размах" = apply(data_num, 2, range_udf, na.rm=TRUE),
            "Минимум" = apply(data_num, 2, min, na.rm=TRUE),
            "Максимум" = apply(data_num, 2, max, na.rm=TRUE),
            "Куртозис" = apply(data_num, 2, kurtosis, na.rm=TRUE),
            "Ассиметрия" = apply(data_num, 2, skewness, na.rm=TRUE)
          ))

rownames(num_stats) = c('Цена', 'Дист. до метро, м', 'Мин. срок аренды', 'Общ. площ.', 'Жил. площ.', 'Площ. кухн.', 'Кол-во этажей в доме', 'Номер этажа', 'Широта', 'Долгота', 'Год постройки дома')


rounding = function(x){
  if(abs(x)<1){
    x = round(x, 3)
  } 
  else if(abs(x)<10){
    x = round(x, 2)
  }
  else if(abs(x)<100){
    x = round(x, 1)
  }
  else {
    x = round(x, 0)
  }
  return(x)
}



for (col in colnames(num_stats)){
  num_stats[, col] = sapply(num_stats[, col], rounding)
}



kable(num_stats) %>% kable_styling(bootstrap_options = c('condensed'), full_width = F, font_size = 15) %>%
  scroll_box(width = "100%", height = "600px")
```

Видно, что все большинство величин скошенны вправо(ассиметрия>0). Это объясняется природой данных: все величины у нас положительны, большинство значений близки к левой границе распределения, но при этом существует несколько наблюдений, сильно выбивающихся из общей тенденции, то есть наблюдений, смещенных к правой части распределения(слишком дорогие/большие квартиры, слишком отдаленные от метро, слишком высокоэтажные дома).\
Данные, не следующие этой логике:  
1. Широта и долгота. Они не являются сильно скошенными в ту или иную сторону. Это означает то, что в среднем все квартиры симметрично распределены вокруг условного "центра"(то есть среднего) широты(и долготы соответственно).\
2. Год постройки - данные скорее ограничены справа, чем слева. Т.к. домов, построенных позже текущего момента не существует, в среднем все дома относительно новые, но при этом существует несколько очень старых домов, поэтому распределение скошено влево.




# Графики частот номинальных данных

## Регион

```{r}
g <- ggplot(data, aes(Region, fill=Region))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по регионам") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y =element_text(size = 11,color = "grey20")) + 
xlab("Регион") +
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, vjust=-0.5) +
  scale_fill_manual(aesthetics = 'fill', name = 'Region',
                      values = GrandBudapest(length(unique(data$Region))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Из графика видно, что абсолютное большинство квартир расположено в Санкт-Петербурге. Скорее всего это связано с тем, что плотность жилья в Санкт-Петербурге гораздо выше, чем в регионе. Также в городе гораздо больше людей, желающих сдать квартиру.

## Район

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(District_ad),District_ad, function(x) length(x)), fill=District_ad))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по районам") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20"))  +   
xlab("Район") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) +
coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'District_ad',
                      values = GrandBudapest(length(unique(data$District_ad))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Самыми популярными районами для сдачи квартиры являются: Московский, Центральный, Приморский. А наименее популярными: Петродворцовый, Курортный, Колпинский, Ломоновский (вероятно, в виду их удаленности от центра)

## Метро

```{r fig.height= 10, fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Metro),Metro, function(x) length(x)), fill=Metro))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по станциям метро") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 5.5,color = "grey20"))  + 
xlab("Станция метро") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=2.5, hjust= -0.2)  +
coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Metro',
                      values = GrandBudapest(length(unique(data$Metro))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Самыми популярными станциями метро являются: Приморская, Комендантский проспект, Московская, Ленинский проспект. А наименее популярными Шушары, Пушкинская, Павловск, Лаврики, Колпино, Волковская. Такое распределение легко объясняется спецификой распределения квартир по районам: наиболее часто встречающиеся станции - те, что находятся в районах с самым большим количеством квартир - Московском, Центральном, Приморском.

## Комнаты

```{r fig.width= 10}
g <- data %>% drop_na(Rooms) %>% ggplot(aes(x = reorder(factor(Rooms),Rooms, function(x) length(x)), fill=factor(Rooms)))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по количеству комнат в квартире") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20"))  +   
xlab("Колиичество комнат") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) +
coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Rooms',
                      values = GrandBudapest(length(unique(data$Rooms))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

На графике видна явная тенденция: число наблюдений уменьшается с ростом числа комнат. Это кажется вполне разумным: чем больше комнат в квартире, тем она дороже. Следовательно, у меньшего числа людей в собственности есть такая квартира (особенно для сдачи в аренду). Эта тенденция нарушается лишь квартирами студиями. Полагаем, что это возникает из-за того, что не все арендодатели прописывают в объявлении тип однокомнатной квартиры.

## Сдача с посредником и без

```{r}
g <- ggplot(data, aes(No_agents, fill=No_agents))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений с посредником и без") + theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20"))  + 
xlab("Посредник") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, vjust=2.5)+
  scale_fill_manual(aesthetics = 'fill', name = 'No_agents',
                      values = GrandBudapest(length(unique(data$No_agents))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Большинство квартир сдаются с посредником. Это может быть объяснено желанием арендодателей обезопасить себя, избавиться от лишних хлопот.


## Здание

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Building),Building, function(x) length(x)), fill=Building))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по материалу зданий") + theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20"))  +  
xlab("Материал, из которого сделано здание") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) + coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Building',
                      values = GrandBudapest(length(unique(data$Building))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Большая часть зданий, в которых расположены квартиры сделаны либо из кирпича, либо из монолитного кирпича. Полагаем, что это происходит из-за особенностей жилового фонда Санкт-Петербурга.

## Лифт

```{r}
g <- ggplot(data, aes(Lift, fill=Lift))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по наличию лифта") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) +
xlab("Наличие лифта") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, vjust=-0.5) +
  scale_fill_manual(aesthetics = 'fill', name = 'Lift',
                      values = GrandBudapest(length(unique(data$Lift))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

В большинстве домов (примерно 60%), в которых сдаются квартиры, есть лифт. Это может быть связано с тем, что в выборке присутствует множество квартир либо из домов малой этажности, либо из старых домов, в которых лифтов нет

## Мебелирование квартиры

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Furnished),Furnished, function(x) length(x)), fill=Furnished))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по типу меблирования квартиры") + theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Тип меблирования квартиры") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) + coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Furnished',
                      values = GrandBudapest(length(unique(data$Furnished))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

В большей части объявлений либо написано о типе установленной мебели, либо нет никаких данных о мебели. На наш взгляд это может быть связано с тем, что люди не хотят отпугнуть потенциальных арендаторов отсутствием мебели в своей квартире.

## Ванная

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Bath),Bath, function(x) length(x)), fill=Bath))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по типу ванной комнаты") + theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Тип ванной комнаты") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) + coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Bath',
                      values = GrandBudapest(length(unique(data$Bath))), guide=FALSE)
```

Половина всех объявлений не содержит никаких данных о типе ванной комнаты. Следующий по популярности вариант - "Отдельная". Предполагаем, что авторы объявлений либо указывают преимущество квартиры в виде раздельной ванной комнаты, либо не указывают вообще ничего, чтобы не отпугнуть потенциальных арендаторов.

## Тип ремонта

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Refurbished),Refurbished, function(x) length(x)), fill=Refurbished))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по типу ремонта")+ theme_minimal() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20"))  + 
xlab("Тип ремонта") + 
ylab("Количество наблюдений") + geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) + coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Refurbished',
                      values = GrandBudapest(length(unique(data$Refurbished))), guide=FALSE)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Полагаем, что ситуация аналогична ситуации с ванной комнатой. Арендодатели либо указывают преимущество в виде евроремонта (или ремонта как такового), либо не указывают ничего ("нет данных"). Мотивация тут такая же, как и с указыванием типа ванной комнаты и наличия мебели - арендодатели не хотят отпугнуть арендаторов.

## Балкон 

```{r fig.width= 10}
g <- ggplot(data, aes(x = reorder(factor(Balcony),Balcony, function(x) length(x)), fill=Balcony))
g + geom_bar(color = 'black',size = 1) + ggtitle("Количество наблюдений по типу балкона")+ theme_minimal() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Тип балкона") + 
ylab("Количество наблюдений") + 
geom_text(stat='count', aes(label=..count..),size=4.3, hjust= -0.1) + coord_flip() +
  scale_fill_manual(aesthetics = 'fill', name = 'Balcony',
                      values = GrandBudapest(length(unique(data$Balcony))), guide=FALSE) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

В большинстве объявлений отсутствует информация о балконе. Следующий по популярности идет вариант о его наличии, за ним - о наличии лоджии, при этом очень мало объявлений с эркерами и большим количеством балконов/лоджий. Мы считаем, что это напрямую связано с особенностями жилья в Санкт-Петербурге. Для Петербурского жилья характерно наличие лишь одного балкона/лоджии.

# Графики распределения числовых переменных

## Расстояние до метро

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Dist_metro_ad,..density..))
g + geom_histogram(bins = 50, fill='#F1BB7B') + ggtitle("Расстояние до метро") + 
scale_x_continuous(limits=c(0,20000)) + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Расстояние до ближайшей станции метро (в метрах)") + 
ylab("Эмпирическая плотность распределения") + 
geom_density(size = 0.5) + 
geom_vline(aes(xintercept = median(Dist_metro_ad), color = 'median'), linetype = "longdash", size=0.7)+
geom_vline(aes(xintercept = mean(Dist_metro_ad), color = 'mean'), linetype = "longdash", size=0.7)+
scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

На данном графике максимальное расстояние до метро ограничено 20 000 метров, это сделано для лучше йвизуализации. Тажке существует несколько наблюдений, которые выходят за данную границу - они расположены в Ленинградской области.\
Распределение сильно скошено вправо. При этом в среднем квартиры расположены на ~2км. от метро. Это объясняется тем, что площадь застройки(в том числе жилой) вокруг метро обычно высокая.

## Цена

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Price,..density..))
g + geom_histogram(fill="#F1BB7B", bins = 50) + ggtitle("Наемная цена квартиры") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Цена квартиры (в тысячах рублей/месяц)") + 
ylab("Эмпирическая плотность распределения") + 
geom_density(size = 0.8) + 
geom_vline(aes(xintercept = median(Price), color = 'median'), linetype = "longdash", size=0.7)+
geom_vline(aes(xintercept = mean(Price), color = 'mean'), linetype = "longdash", size=0.7)+
scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Распределение скошено вправо. Это происходит из-за того, что существует несколько квартир, цена аренды которых крайне высока. Однако цена аренды большинства квартир варируется от 20 до 50 тысяч рублей. Среднее - 43 тысячи рублей, медиана - 30 тысяч рублей.

## Минимальная продолжительность договора

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Minimum_duration,..density..))
g + geom_histogram(fill="#F1BB7B", bins = 50) + ggtitle("Минимальная продолжительность заключения договора") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Минимальная продолжительность (в месяцах)") + 
ylab("Эмпирическая плотность распределения") + 
geom_density(size = 0.8)+ 
geom_vline(aes(xintercept = median(Minimum_duration, na.rm = TRUE), color = 'median'), linetype = "longdash", size=0.7)+
geom_vline(aes(xintercept = mean(Minimum_duration,na.rm = TRUE), color = 'mean'), linetype = "longdash", size=0.7)+
scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Как видно из графика - большинство людей хотят сдать свою квартиру минимум на год. Также есть люди, которые хотят сдать квартиру на 6 или на 1 месяц минимум. Такие красивые даты могут быть объяснены психологическими причинами. Многие люди не хотят сдавать свою квартиру на несколько дней, но при этом боятся спугнуть арендаторов слишком большим сроком и поэтому ставят 1 месяц. Кто-то хочет сдать квартиру на длительный срок, но при этом также боится спугнуть покупателей и ставит 6 месяцев, вместо 12. При этом многие люди все равно сдают свою квартиру минимум на год. Таже существует несколько объявлений, в которых минимальный срок аренды указан равным 31 месяцам. Возможно, люди уезжают куда-то на длительный срок и поэтому хотят сдать свою недвижимость сразу на длительный период.

## Площади

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Area_total,..density..))
hist_total =  g + geom_histogram(fill="#F1BB7B", bins = 50) + ggtitle("Общая площадь квартиры") + 
  theme_minimal() + 
  scale_x_continuous(limits=c(0,200)) +
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Общая площадь квартиры (в кв. м)") + 
  ylab("") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Area_total), color = 'median'), linetype = "longdash", size=0.7)+
  geom_vline(aes(xintercept = mean(Area_total), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Area_living,..density..))
hist_liv =  g + geom_histogram(fill="#F1BB7B", bins = 50) + ggtitle("Жилая площадь квартиры") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Жилая площадь квартиры (в кв. м)") + 
  ylab("Эмпирическая плотность распределения") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Area_living), color = 'median'), linetype = "longdash", size=0.7)+
  geom_vline(aes(xintercept = mean(Area_living), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Area_kitchen,..density..))
hist_kitch =   g + geom_histogram(fill="#F1BB7B", bins = 50) + ggtitle("Площадь кухни квартиры") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Площадь кухни (в кв. м)") + 
  ylab("") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Area_kitchen), color = 'median'), linetype = "longdash", size=0.7)+
  geom_vline(aes(xintercept = mean(Area_kitchen), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r fig.height= 15, fig.width= 15}
grid.arrange(hist_total, hist_liv, hist_kitch)
```

На графиках выше видно, что данные распределения скошены вправо. При этом на гистограммах существуют "провалы", скорее всего это происходит из-за конструктивных особенностей квартир, т.к. застройка в своем большинстве типовая, поэтому некоторые интревалы площадей отсутствуют в выборке.

## Этаж квартиры и количество этажей в доме

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Floor,..density..))
hist_floor  = g + geom_histogram(fill="#F1BB7B", bins = 30) + ggtitle("Этаж") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Этаж, на котором расположена квартира") + 
  ylab("Эмпирическая плотность распределения") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Floor), color = 'median'), linetype = "longdash", size=0.7)+
  geom_vline(aes(xintercept = mean(Floor), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


```{r}
data$NFloor = as.numeric(data$NFloor) 
options(scipen=10000) 
g <- ggplot(data, aes(NFloor,..density..))
hist_nfloors  = g + geom_histogram(fill="#F1BB7B", bins = 30) + ggtitle("Количество этажей в доме") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Количество этажей") + 
  ylab("Эмпирическая плотность распределения") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(NFloor), color = 'median'), linetype = "longdash", size=0.7) +
  geom_vline(aes(xintercept = mean(NFloor), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r fig.width=15}
grid.arrange(hist_floor, hist_nfloors, ncol = 2)
```


Распределение количества этажей в доме скошено вправо и имеет множество пиков. Плотность вероятности уменьшается с увеличением количества этажей. Это, в целом, свидетельствует о том, что квартиры сдают в разных домах, с небольшим преобладанием малоэтажных. Множество пиков обусловлено спецификой архитектуры Петербурга, в застройке которого существует много домов определенной высоты (например, четырех-, пяти-, десяти-, пятнадцати- этажных) и мало - другой высоты (например, семи-, двенадцати- этажных).\
Распределение этажей, на которых расположена съемная квартира сосредоточено вокруг пятого этажа и, в целом, скошено вправо. Однако у него очень "толстые" хвосты, что свидетельствует о том, что квартиры могут находится и на больших этажах.


## Широта и долгота

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Latitude,..density..))
hist_lat = g + geom_histogram(fill="#F1BB7B", bins = 30) + ggtitle("Географическая широта") +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Широта (в градусах)") + 
  ylab("Эмпирическая плотность распределения") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Latitude, na.rm = TRUE), color = 'median'), linetype = "longdash", size=0.7) +
  geom_vline(aes(xintercept = mean(Latitude, na.rm = TRUE), color = 'mean'), linetype = "longdash", size=0.7) +
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Longitude,..density..))
hist_lon  = g + geom_histogram(fill="#F1BB7B", bins = 30) + ggtitle("Географическая долгота") +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
  xlab("Долгота (в градусах)") + 
  ylab("Эмпирическая плотность распределения") + 
  geom_density(size = 0.8) + 
  geom_vline(aes(xintercept = median(Longitude, na.rm = TRUE), color = 'median'), linetype = "longdash", size=0.7) +
  geom_vline(aes(xintercept = mean(Longitude,na.rm = TRUE), color = 'mean'), linetype = "longdash", size=0.7)+
  scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
  theme(legend.position = c(0.9, 0.9))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r fig.width=15}
grid.arrange(hist_lat, hist_lon, ncol = 2)
```

Координаты долготы распределены почти нормально. Это связано с тем, что большая часть квартир расположена вокруг условного центра(то есть средней долготы). При этом в распределении широты есть некоторые провалы. Скорее всего это происходит из-за особенностей ландшафта Санкт-Петербурга и Ленинградской области. Вероятно, что в "провалах" широты расположены промзоны, реки или какие-то другие площади с отсутствующей жилой застройкой.

## Год постройки

```{r}
options(scipen=10000) 
g <- ggplot(data, aes(Year_construction,..density..))
g + geom_histogram(fill="#F1BB7B", bins = 30) + ggtitle("Год постройки") + 
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(size = 11,color = "grey20"), axis.text.y = element_text(size = 11,color = "grey20")) + 
xlab("Год постройки дома") + 
ylab("Эмпирическая плотность распределения") + 
geom_density(size = 0.8) +
geom_vline(aes(xintercept = median(Year_construction,na.rm = TRUE), color = 'median'), linetype = "longdash", size=0.7) +
geom_vline(aes(xintercept = mean(Year_construction,na.rm = TRUE), color = 'mean'), linetype = "longdash", size=0.7)+
scale_color_manual(name = "", values = c('median' = "#5B1A18", 'mean' = "red"), labels = c('Среднее', 'Медиана'))+
theme(legend.position = c(0.1, 0.9))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Распределение сосредоточено вокруг 2015 года, сильно скошено влево и имеет "толстый" хвост. По графику видно, что большинство домов, в которых сдаются квартиры, были построены в двухтысячных. Также в данных присутствует небольшая часть домов, построенных в период 1950 - 2000 годов. Такой вид распределения может быть объяснен "бумом" развития пригородов Санкт-Петербурга: строительством множества домов в так называемых "спальных окраинах": Мурино, Девяткино, Кудрово и других.

# Диаграммы рассеяния

```{r}
data$Price_per_m = data$Price / data$Area_total
```

## Регион расположения сдаваемой квартиры

Как мы видим из ниже приведенных графиков, в среднем, цена в городе выше, чем цена в области. Это видно как из сравненя медиан, так и расположения основных 50% данных, располагающихся между 25-м и 75-м квантилями. При этом разброс данных больше в городе, как с большими, так и с меньшими значениями. Высокий разброс связан с тем, что в городе предлагается больше квартир в аренду. При этом, в городе больше значений, не входящих в статистически значимую часть выборки, так как в городе более высокий уровень жизни, из-за чего на рынке предлагается больше дорогих и больших квартир. 

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Region, y = log(Price), color=Region)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Region',
                      values = GrandBudapest(length(unique(data$Region))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Региона расположения квартиры") +
    labs(x = "Регион расположения", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Region, y = log(Price_per_m), color=Region)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Region',
                      values = GrandBudapest(length(unique(data$Region))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Региона расположения квартиры") +
    labs(x = "Регион расположения", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Район расположения сдаваемой квартиры

Относительно районов можно выделить следующие закономерности. Самыми дорогими районами являются Петроградский и Василеостровский из-за близости исторического центра и наличия многих жилых комплексов класса Комфорт и выше, Центральный и Адмиралтейский из-за близости исторического центра. Самыми дешевыми являются Ломоносовский и Петродворцовый за счет дальности от центра города. В остальных районах распределение цены за квадратный метр примерно одинаковое. При этом из графика по стоимости аренды видно, что распределение Курортного района выше обычного распределения, так как там много сдаваемых дачных участков и больших жилых комплексов для всей семьи для отдыха на природе, а Всеволожский и Колпинский имеют распределение ниже, так как это не самые процветающие районы, поэтому там находятся в основном маленькие квартиры, ибо другое малообеспеченное население позволить себе не может.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = District_ad, y = log(Price), color=District_ad)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'District_ad',
                      values = GrandBudapest(length(unique(data$District_ad))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Района расположения квартиры") +
    labs(x = "Район расположения", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = District_ad, y = log(Price_per_m), color=District_ad)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'District_ad',
                      values = GrandBudapest(length(unique(data$District_ad))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Района расположения квартиры") +
    labs(x = "Район расположения", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Ближайшая станция метро

Из анализа станций метро видно, что самые дорогие квартиры сдаются около Крестовского острова, Маяковской, Петроградской и Чкаловской, так как в этих округах находятся элитные жилые кварталы, которые дорого стоят. Из графика по цене за квадратный метр можно понять, в каких округах низкая цена жилья. Но часто меньшее распределение объясняется тем, что по данной станции метро слишком мало значений, как в случае с Бухарестской. Также можно выделить дорогие станции метро как площадь Александра Невского, Адмиралтейская, Выборгская, Горьковская и Черная речка (и др.), вокруг которых много жилых комплексов класса не меньше, чем "Бизнес". Их медианы цен за квадратный метр, как и сами ящики, лежат выше, чем у других районов. При этом на графике от стоимости аренды их отрыв от остальных районов увеличивается за счет большего предложения больших квартир, которых в этих округах больше из-за более высокого уровня жизни.

```{r, fig.width = 10, fig.height=7}

data %>%
  ggplot(aes(x = Metro, y = log(Price), color=Metro)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Metro',
                      values = GrandBudapest(length(unique(data$Metro))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Ближайшей станции метро") +
    labs(x = "Ближайшая станция метро", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=7}

data %>%
  ggplot(aes(x = Metro, y = log(Price_per_m), color=Metro)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Metro',
                      values = GrandBudapest(length(unique(data$Metro))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Ближайшей станции метро") +
    labs(x = "Ближайшая станция метро", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Участие агента в сделке

Как мы видим из графика по цене за квадратный метр, участие агента увеличивает вероятность более высокой цены, на что указывает граница 75-го квантиля. Возможно, также, это объясняется тем, что агента могут позволить себе помимо прочих обеспеченные люди, которые продают изначально дорогие квартиры. Такие люди и могут поднимать границу 75-го квантиля. А в остальном распрделение цены за квадратный метр крайне похоже для обеих категорий. Если мы посмотрим на график стоимости аренды, то заметим, что нижняя граница усов меньше у сделок с агентом. Мое предположение, что это происходит из-за людей, которые сдают маленькие студии, которые сейчас в ходу, и хотят на этом заработать, поэтому для уменьшения рисков прибегают к помощи агентов. Маленькие студии суммарно стоят меньше, поэтому и сдвигают нижнюю границу усов.

```{r, fig.width = 10, fig.height=4.5}

data %>%
  ggplot(aes(x = No_agents, y = log(Price), color=No_agents)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'No_agents',
                      values = GrandBudapest(length(unique(data$No_agents))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от участия агента в сделке") +
    labs(x = "Наличие агента", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=4.5}

data %>%
  ggplot(aes(x = No_agents, y = log(Price_per_m), color=No_agents)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'No_agents',
                      values = GrandBudapest(length(unique(data$No_agents))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от участия агента в сделке") +
    labs(x = "Наличие агента", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Тип здания

Если посмотреть на график цены за квадратный метр, то можно заметить, что основное скопление значений для каждого типа лежит в одном и том же общем промежутке, что говорит о том, что данная переменная не представляет особого значения для цены. Даже значения, которые имеют длинные усы за счет большего количества и разброса наблюдений, имеют ящик, лежащий в том же промежутке, что и у менее популярных типов. Заметим, что более популярные типы являются самыми универсальными, как Кирпич или Монолит, вероятно, так как соответствие типа здания им легче определить. При этом, стоимость аренды так сильно разнится из-за неравенства распределения размера квартир по типам здания. У более популярных и универсальных типов больше расброс по размеру квартир, поэтому и стоимость у них часто будет больше, что показывает более высокое положение ящика с усами.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Building, y = log(Price), color=Building)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Building',
                      values = GrandBudapest(length(unique(data$Building))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Типа здания") +
    labs(x = "Тип здания", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Building, y = log(Price_per_m), color=Building)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Building',
                      values = GrandBudapest(length(unique(data$Building))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Типа здания") +
    labs(x = "Тип здания", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Наличие лифта

Удивительно, но распределения как и по стоимости аренды, так и по цене за квадратный метр попарно одинаковы для квартир с лифтов в доме, так и квартир без лифта в доме. Я не представляю, почему так происходит. Допустим, что лифт есть во многих многоэтажках, которые в основном строятся для среднего и низшего класса, а квартиры без лифта еть в основном маленьких домах для людей с высоким доходом. некие аналоги таунхауса. Тогда можно предположить, что из-за надбавки за лифт у квартир в многоэтажных домах распределение квартир с лифтом приближается к более дорогим квартирам без лифта в доме. Или же люди просто не обращают внимание на этот пункт при выборе квартиры.

```{r, fig.width = 10, fig.height=4.5}

data %>%
  ggplot(aes(x = Lift, y = log(Price), color=Lift)) +
    geom_point(alpha=.3, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Lift',
                      values = GrandBudapest(length(unique(data$Lift))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Наличия лифта") +
    labs(x = "Наличие лифта", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=4.5}

data %>%
  ggplot(aes(x = Lift, y = log(Price_per_m), color=Lift)) +
    geom_point(alpha=.3, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Lift',
                      values = GrandBudapest(length(unique(data$Lift))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Наличия лифта") +
    labs(x = "Наличие лифта", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Наличие мебели

Здесь мы наблюдаем ситуацию, аналогичную с предыдущей парой. Распределение не меняется от перехода к другому типу. Вероятно, это так же определяется тем, что арендующие мало внимания уделяют выбору мебели. Но заметим, что более продвинутые типы мебели как Сборная Современная или Сборная + Кухонный гарнитур имеют более высокое по значениям распределение, хотя отличается от других оно не намного. Поэтому можно предположить, что мебелированность очень слабо влияет на цену.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Furnished, y = log(Price), color=Furnished)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Furnished',
                      values = GrandBudapest(length(unique(data$Furnished))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Наличия мебели") +
    labs(x = "Наличие мебели", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Furnished, y = log(Price_per_m), color=Furnished)) +
    geom_point(alpha=.1, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Furnished',
                      values = GrandBudapest(length(unique(data$Furnished))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Наличия мебели") +
    labs(x = "Наличие мебели", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Тип ванной комнаты

По ванным комнатам ситуация так же похожа на ситуацию с мебелью, где распределение и расположение медиан и ящиков примерно одинаковое для каждого типа. Длина усов определяется только популярностью типа, которая определяется универсальностью типа. Арендодатели мало представляют, чем попереченая ванна отличается от продольной. Им понятнее категории Душ, Отдельная и Совмещенная, поэтому среди них больше наблюдений. Вероятно, такая же ситуация и у арендаторов, так как им важнее наличие ванной, чем её тип, в котором они не всегда разбираются. Исходя из схожести основных параметров выборочных распределений можно сказать, что наличие ванной так же не сильно влияет а цену.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Bath, y = log(Price), color=Bath)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Bath',
                      values = GrandBudapest(length(unique(data$Bath))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Типа ванной комнаты") +
    labs(x = "Тип ванной", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Bath, y = log(Price_per_m), color=Bath)) +
    geom_point(alpha=.5, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Bath',
                      values = GrandBudapest(length(unique(data$Bath))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Типа ванной комнаты") +
    labs(x = "Тип ванной", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Проведение ремонта в сдаваемой квартире

Из этих графиков мы видим, что в большинстве домов/квартир сделан ремонт и распределение цен и стоимости в домах с выполненным ремонтом выше, чем у домов/квартир с невыполненным ремонтом. Что интересно, у квартир с указанным
фактом ремонтом распределение цены и стоимости выше, чем при указании, что ремонт не требуется. Вероятно, факт совершения ремонта говорит об улучшенных характеристиках квартиры и её большей современности, так как во время ремонта она обновилась с использованием современных средств и технологий. 

```{r, fig.width = 10, fig.height=6}
data %>%
  ggplot(aes(x = Refurbished, y = log(Price), color=Refurbished)) +
    geom_point(alpha=.15, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.5) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Refurbished',
                      values = GrandBudapest(length(unique(data$Refurbished))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Ремонта в квартире") +
    labs(x = "Статус ремонта", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами', caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}
data %>%
  ggplot(aes(x = Refurbished, y = log(Price_per_m), color=Refurbished)) +
    geom_point(alpha=.15, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.5) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour', name = 'Refurbished',
                      values = GrandBudapest(length(unique(data$Refurbished))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Ремонта в квартире") +
    labs(x = "Статус ремонта", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами', caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Тип балкона

Замтеим, что распределение по цене одинаково у типов балкона, которые не включают дополнений и у типов балкона с дополнениями или большим количеством объектов типа балкона, при этом у вторых распределение выше. При этом, если мы посмотрим на график от стоимости, то заметим, что второй класс находится ещё выше. На наш взгляд, это происходит так из-за того, что такие продвинутые типы в основном встречаются в больших и дорогих элитных квартирах с изначально большей наценкой и площадью. И объяснение находится не в балконе, а в том, в каких квартирах он находится. Исходя из того, что внутри этих классов распределение примерно одинаковое, то для покупателя важен лишь факт наличия балкона скорее, чем его тип.Поэтому, нам кажется, что этот показатель, исходя из выше сказанного, мало влияет на стоимость квартиры. 

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Balcony, y = log(Price), color=Balcony)) +
    geom_point(alpha=.15, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 50, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Balcony',
                      values = GrandBudapest(length(unique(data$Balcony))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Типа балкона") +
    labs(x = "Тип балкона", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))


```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Balcony, y = log(Price_per_m), color=Balcony)) +
    geom_point(alpha=.15, size=4) + 
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 50, hjust = 1)) +
    scale_fill_manual(aesthetics = 'colour', name = 'Balcony',
                      values = GrandBudapest(length(unique(data$Balcony))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Типа балкона") +
    labs(x = "Тип балкона", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))


```

## Расстояние до метро

Из данных крайне похожих графиков можно заметить, что с уменьшением расстояния увеличивается плотность распределения наблюдений. То есть, предложение квартир обратно пропорционально расстоянию до метро. То есть, основное предложение сосредоточено вблизи метро, так как на него самый большой спрос. Возможно, люди специально покупают квартиры у метро, чтобы сдавать их в аренду и зарабатывать на этом. При этом, если мы отметим, что разброс цены, как и условное среднее увеличивается при уменьшении расстояния до метро, что означает, что более дорогие квартиры сосредотачиваются у метро (возможно, как раз из-за большого спроса), поэтому цена и стоимость зависят от расстояния до метро и стратегия осознанной сдачи в аренду ещё больше оправдана.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Dist_metro_ad, y = Price, color=Dist_metro_ad)) +
    geom_point(aes(fill=Dist_metro_ad), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Darjeeling1")), aesthetics='fill', name='Dist_metro_ad', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Расстояния до метро") +
    labs(x = "Расстояние до метро, м", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Dist_metro_ad, y = Price_per_m, color=Dist_metro_ad)) +
    geom_point(aes(fill=Dist_metro_ad), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Darjeeling1")), aesthetics='fill', name='Dist_metro_ad', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Расстояния до метро") +
    labs(x = "Расстояние до метро, м", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Общая площадь квартиры

Мы думаем, что тут много говорить не надо. Мы видим крайне логичную зависимость стоимости квартиры от общей площади, так как стоимость можно представить как цену за квадратный метр на метраж квартиры. А зависимость цены от общей площади практически отсутствует, так как цена за квадратный метр определяется качественными характеристиками квартиры нежели, чем метражом, например, благополучностью района. Площадь ничего не говорит о качестве квартиры. Поэтому не влияет на цену за квадратный метр.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_total, y = Price, color=Area_total)) +
    geom_point(aes(fill=Area_total), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Royal2")), aesthetics='fill', name='Area_total', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Общей площади") +
    labs(x = "Общая площадь квартиры, м2", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_total, y = Price_per_m, color=Area_total)) +
    geom_point(aes(fill=Area_total), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Royal2")), aesthetics='fill', name='Area_total', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Общей площади") +
    labs(x = "Общая площадь квартиры, м2", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Жилая площадь

У жилой площади почти такое же совместное распределение с ценой и зависимость, так как большая часть общей площади - это жилая площадь, поэтому для неё наблюдаются те же выводы, что и для общей площади.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_living, y = Price, color=Area_living)) +
    geom_point(aes(fill=Area_living), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Zissou1")), aesthetics='fill', name='Area_living', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Жилой площади") +
    labs(x = "Жилая площадь квартиры, м2", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_living, y = Price_per_m, color=Area_living)) +
    geom_point(aes(fill=Area_living), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Zissou1")), aesthetics='fill', name='Area_living', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Жилой площади") +
    labs(x = "Жилая площадь квартиры, м2", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Площадь кухни

У площади кухни уже намного слабее выражаются зависимости общей и жилой площадей. Для кухни больше похоже на то, что она не влияет на стоимость аренды, как минимум с какого-то порогового значения (например, 15 м2). Нам кажется, что кухня, во-первых, составляет малую часть от общей площади, поэтому слабо влияет на стоимость. Во-вторых, сейчас людям не сильно важен размер кухни, так как большую часть времени они проводят в других комнатах, а кухня нужна только для приготовления пищи. Даже для еды обычно сейчас используют и выделяют другие комнаты. Кроме того, по мере развития сервисов доставки еды надобность в самостоятельном приготовлении пищи отпадает и нужда в кухне уменьшается. Поэтому люди не меньше готовы доплачивать как за наличие кухни, так и за ее размер.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_kitchen, y = Price, color=Area_kitchen)) +
    geom_point(aes(fill=Area_kitchen), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = wes_palette("Rushmore1"), aesthetics='fill', name='Area_kitchen', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Площади кухни") +
    labs(x = "Площадь кухни в квартире, м2", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Area_kitchen, y = Price_per_m, color=Area_kitchen)) +
    geom_point(aes(fill=Area_kitchen), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = wes_palette("Rushmore1"), aesthetics='fill', name='Area_kitchen', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Площади кухни") +
    labs(x = "Площадь кухни в квартире, м2", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Минимальный срок аренды

Исходя из этих графиков заметны основные округленные сроки договора аренды - 1 месяц, полгода, год и почему-то 32 месяца. Заметим, что распределение для полугода незначительно, но выше, чем для месяца, так как месяц можно рассматривать как пробный период, на который делается дисконт. Также сдача на месяц возможно обоснована внезапной надобностью сдать квартиру, а не размеренным решением намеренно и долгосрочно сдавать квартиру. Поэтому чтобы решить текущую проблему со сдачей квартиры, арендодатель предлагает меньшую стоимость, чтобы её побыстрее арендовали. Далее с увеличением срока аренды цена и стоимость увеличиваются. Так как чем меньше срок, тем больше возможностей у арендодателя сменить арендующего и избавиться от предыдующего арендатора. И это льгота компенисируется меньшей ценой. С увеличением срока начинает действовать другой эффект, что арендатор не может легко отказаться от аренды и сменить квартиру, так как скован условиями договора. Поэтому с увеличением времени стоимость уменьшается, что и видно при переходе от года к 32 месяцам. Поэтому минимальный срок аренды влияет на цену.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Minimum_duration, y = Price, color=Minimum_duration)) +
    geom_point(aes(fill=Minimum_duration), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("GrandBudapest2")), aesthetics='fill', name='Minimum_duration', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Минимального срока аренды") +
    labs(x = "Минимальный срок аренды, м", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Minimum_duration, y = Price_per_m, color=Minimum_duration)) +
    geom_point(aes(fill=Minimum_duration), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("GrandBudapest2")), aesthetics='fill', name='Minimum_duration', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Минимального срока аренды") +
    labs(x = "Минимальный срок аренды, м", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Год постройки

Ну тут говорить нечего. С увеличением года постройки помимо увеличения предложения из-за постоянного роста рынка строительства. Также после 2000 года с увеличением года строительства начинается увеличиваться цена за квадратный метр, так как на рынок вошли новые продвинутые технологии, которые позволили строить более качественные дома и лучше оборудовать квартиры. Также более молодые дома более стойкие, прочные и несут меньше рисков нежели, чем более старые, как возможность протекания или ухудшения внутренней облицовки. Поэтому год строительства прямым образом должен влиять на цену.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Year_construction, y = Price, color=Year_construction)) +
    geom_point(aes(fill=Year_construction), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("IsleofDogs1")), aesthetics='fill', name='Year_construction', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Года постройки") +
    labs(x = NULL, y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Year_construction, y = Price_per_m, color=Year_construction)) +
    geom_point(aes(fill=Year_construction), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("IsleofDogs1")), aesthetics='fill', name='Year_construction', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Года постройки") +
    labs(x = NULL, y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_continuous(breaks=pretty_breaks(n=10))

```

## Этаж расположения квартиры

Мы видим, что большинство наблюдений сконцентрировано на этажах меньше десятого. На этих этажах Так же более широкое распределение, его размах больше, чем на более высоких. Это, на наш взгляд, связано с тем, что в Петербурге была долгое время малоэатажная застройка, особенно в близких к метро и историческому центру районах, что влияет на цену и стоимость. Поэтому сам этаж расположения не влияет на цену.

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Floor, y = Price, color=Floor)) +
    geom_point(aes(fill=Floor), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Cavalcanti1")), aesthetics='fill', name='Floor', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Этажа") +
    labs(x = "Этаж", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data %>%
  ggplot(aes(x = Floor, y = Price_per_m, color=Floor)) +
    geom_point(aes(fill=Floor), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Cavalcanti1")), aesthetics='fill', name='Floor', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Этажа") +
    labs(x = "Этаж", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Количество этажей в доме

Аналогичная ситуация и с количеством этажей в доме. График и совместное распределение крайне напоминают свои аналоги в номере этажа. Из-за ограниченности домодерновой малоэтажной постройки большинство квартир в городе сосредоточены на низких этажах, а причины, по которым на этих низких этажах более высокая стоимость мы пояснили выше. Поэтому само количество этажей не влияет на цену.

```{r, fig.width = 10, fig.height=6}

data$NFloor = sapply(data$NFloor, function(x) as.integer(unlist(strsplit(as.character(x), ' '))[1]))

data %>%
  ggplot(aes(x = NFloor, y = Price, color=NFloor)) +
    geom_point(aes(fill=NFloor), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Moonrise3")), aesthetics='fill', name='NFloor', guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды от Количества этажей в доме") +
    labs(x = "Количество этажей", y = 'Стоимость аренды, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

```{r, fig.width = 10, fig.height=6}

data$NFloor = sapply(data$NFloor, function(x) as.integer(unlist(strsplit(as.character(x), ' '))[1]))

data %>%
  ggplot(aes(x = NFloor, y = Price_per_m, color=NFloor)) +
    geom_point(aes(fill=NFloor), colour='black', size=6, shape=21) + 
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_gradientn(colours = rev(wes_palette("Moonrise3")), aesthetics='fill', name='NFloor', guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр от Количества этажей в доме") +
    labs(x = "Количество этажей", y = 'Цена за квадратный метр, тыс. руб./месяц', subtitle='Облако рассеивания',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12))

```

## Количество комнат в квартире

Заметим, что с увеличением количества комнат увеличивается цена за метр, хоть и ненамного. Это связано с тем, что дополнительные комнаты дают новые возможности функционального и тематического заполнения пространства. Также, они дают личное пространство для дополнительных членов семьи, что и обеспечивает их надабвку. Цена за метр студии при этом выше, чем за однокомнатную и двукомнатную квартиру, так как сейчас студии пользуются повышенным спросом, а также они в меньшем пространстве совмещают все возможности, функции, технологии и удобства более многокомнатных квартир. Также различие в стоиомсти растет ещё сильнее, так как, помимо всего, с увеличением числа комнат обычно (в среднем) увеличивается площадь квартиры, которая прямым образом влияет на стоимость.

```{r, fig.width = 10, fig.height=7}

data %>%
  drop_na(Rooms)  %>%
  ggplot(aes(x = factor(Rooms), y = log(Price), color=factor(Rooms))) +
    geom_point(size=6) +
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour',
                      values = Royal1(length(unique(data$Rooms))), guide=FALSE) +
    ggtitle("Зависимость Стоимости аренды относительно Количества комнат в квартире") +
    labs(x = "Количество комнат", y = 'Стоимость аренды, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_discrete(breaks=0:9, labels = c('Студия', 1:9))

```

```{r, fig.width = 10, fig.height=7}

data %>%
  drop_na(Rooms)  %>%
  ggplot(aes(x = factor(Rooms), y = log(Price_per_m), color=factor(Rooms))) +
    geom_point(size=6) +
    stat_boxplot(geom ='errorbar', color='black', size=0.3, width=0.3) + geom_boxplot(color='black', outlier.shape = NA, size = 0.7) +
    theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                      axis.line = element_line(colour = "black")) +
    scale_fill_manual(aesthetics = 'colour',
                      values = Royal1(length(unique(data$Rooms))), guide=FALSE) +
    ggtitle("Зависимость Цены за квадратный метр относительно Количества комнат в квартире") +
    labs(x = "Количество комнат", y = 'Цена за квадратный метр, тыс. руб./месяц \n logarithmic scale', subtitle='Облако рассеивания + Ящик с усами',
                      caption = "Данные взяты из учебного датасета") +
    scale_y_continuous(breaks=pretty_breaks(n=12)) + scale_x_discrete(breaks=0:9, labels = c('Студия', 1:9))

```

# Корреляции признаков

Для рассмотрения корреляций я не брал адреса, так как там все значения почти уникальные и не несут особого смысла, а так же широту и долготу, так как эти величины эквивалентны адресу. А все перечисленные величины и так содержатся эксплицитно в Станции метро и Районе.

Во всех последующих таблицах зачеркнуты значения, чей уровень значимости больше 0.05. Они считаются несущественными.

### Рассмотрим корреляционную матрицу Пирсона для числовых параметров.

Матрица нам лает результаты, которые мы уже упоминали. Цена и Стоимость сильно зависят от Общей и Жилой площадей. А площади сильно зависят друг от друга, что неудивительно, так как одна из величин включается в другую.

Ещё заметно, что сильно коррелируют друг с другом количество этажей, номер этажа и год постройки, что опять же связано с тем, какой был тип застройки в Петербурге.

У остальных пар корреляция слабая (меньше 0.25 по модулю), поэтому, на наш взгляд, она не заслуживает рассмотрения.

```{r, fig.width = 10, fig.height=10}

cor_data = select(Filter(is.numeric, data), -Rooms, -Latitude, -Longitude)

cor_table = rcorr(as.matrix(cor_data), type = 'pearson')

corrplot.mixed(cor_table$r, order="hclust", tl.pos = 'lt',
         p.mat = cor_table$P, sig.level = 0.05, tl.col = 'black', 
         upper.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], 
         lower.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], number.cex = 1,
         title = 'Матрица корреляции Пирсона для числовых параметров', mar=c(0,2,1,0))

```

### Рассмотрим корреляционную матрицу Спирмена для ординальных и числовых параметров

Да, относительно числовых параметров это делать не совсем уместно, хотя их тоже можно представить в виде ординальных величин. Тем не менее, корреляция Спирмена не изменяла порядок вещей в нашей матрице. Наиболее значительными связями все так же являются связь Цены, Стоимости и Площадей, а также Года постройки и Этажей. Остальные корреляции слишком малы по модулю, чтобы их рассматривать.

Стоит заметить, что стала отчетливо видна отрицательная зависимость Цены и Стоимости от Дистанции до метро, которую мы и предполагали. 

Тем не менее, обратим на связь числовых параметров с Количеством комнат, нашим единственным ординальным параметром. Они плотно связаны с Площадьми дома, что мы уже объясняли в предыдущем разделе, а также с Ценой и Стоимостью аренды, что мы также объясняли в предыдущем разделе. Ну и банально, со Стоимостью Количество комнат связано через зависимость от Площадей, которые сильно влияют на Стоимость.

```{r, fig.width = 10, fig.height=10}

cor_data = select(Filter(is.numeric, data), -Latitude, -Longitude)

cor_table = rcorr(as.matrix(cor_data), type = 'spearman')

corrplot.mixed(cor_table$r, order="hclust", tl.pos = 'lt',
         p.mat = cor_table$P, sig.level = 0.05, tl.col = 'black', 
         upper.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], 
         lower.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], number.cex = 1,
         title = 'Матрица корреляции Спирмена для ординальных и числовых параметров', mar=c(0,2,1,0))

```

### Рассмотрим корреляционную матрицу для номинальных параметров

Матрица основана на скорректированном   коэффициенте сопряженности Пирсона.

```{r}
CHI <- function(sppx, sppy) 
{test <- chisq.test(table(sppx, sppy), correct = F) 
result <- test$p.value
return(result)
}
```

Из этой интереснейшей матрицы мы видим, что почти все зависимости Цены от номинальных признаков малы и недостаточно значительны. Только с Метро есть положительная зависимость, которую мы и предполагали, и пытались объяснить. Возможно, это, как мы и упоминали, объясняется тем, что арендаторам не важен часто конкретный тип обустроенности квартиры, а просто наличие определенных параметров. Балкон и лифт, как мы и предполагали, слабо влияют на цену.

Но далее самое настоящее веселье. Почти все признаки коррелируют друг с другом. Заметим, что большинство признаков связано с обустройством дома. Поэтому их было бы логично рассматривать комплексно. Итак, с развитием технологий и прогрессом увеличивается качество домов, увеличивается их сложность. Чем позже построен дом, тем лучшего качества он будет, тем лучше он будет оборудован, тем больше шансов, что он будет с усложненными и насыщенными по фактуре квартирами. Поэтому это влияет положительно на Тип здания, наличие лифта, меблированность, тип ванной, состояние ремонта и балкон. Первопричиной предыдущих выводов может стать связь всех признаков с классом комплекса. Не составляет труда представить себе, что чем выше класс комплекса, тем лучше там будут проработаны все составляющие, поэтому они одновременно будут улучшаться по мере увеличения класса.

Метро положительно связано с другими параметрами, так как, как мы уже знаем, ближе к метро наиболее востребованные и дорогие квартиры, поэтому было бы логично, если бы рядом с метро строились самые разные, как и продвинутые жилые комплексы, которые хотели бы увеличить наценку на квартиры за счет расположения. Давайте не забывать, что у нас есть станции метро с условно дорогими ценами и условно не дорогими, как мы узнали в предыдущем разделе. Можно сказать, что есть элитные станции метро с жильем высокого класса вокруг и не самые элитные станции метро с невысоким классом жилья вокруг. А как мы знаем из предыдущего абзаца, более элитное жилье способствует более уютному и качественному обустройству дома. 

Теперь давайте скажем про агентов. Как мы уже упоминали в предыдущем разделе, агентов скорее могут позволить себе обеспеченные люди, которые владеют уже крайне хорошими и благоустроенными квартирами, которые они и сдают. Также, мы говорили, что агентами могут пользоваться арендодатели востребованных студий, которые они обустраивают, чтобы выделяться на фоне конкурентов, предлагая лучшие условия и поднимая цену аренды. Это и объясняет положительную корреляцию.

```{r, fig.width = 10, fig.height=10}

data$factorPrice = ifelse(data$Price_per_m > 1.5, 'High', 'Low')

cor_data = select(data, factorPrice, Region, Metro, No_agents, Building, Lift, Furnished, Bath, Refurbished, Balcony)

#cor_r = chisq.test(cor_data, correct=F)

cor_table = PairApply(cor_data, ContCoef, correct = TRUE, symmetric = TRUE)

p_values = PairApply(cor_data, function(x, y) tryCatch({
  CHI(x, y)}, error = function(e) {NA}), symmetric = TRUE)

corrplot.mixed(cor_table, tl.pos = 'lt',
         p.mat = p_values, sig.level = 0.05,
         tl.col = 'black', 
         upper.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], 
         lower.col = wes_palette('GrandBudapest1')[c(1,2,4,3)], number.cex = 1,
         title = 'Матрица корреляции Спирмена для номинальных параметров', mar=c(0,2,1,0))

```


# Карта

Так как мы не разобрали адреса и географические координаты, то в качестве утешения мы предлагаем интерактивную карту расположения объявлений, которая прекрасно показывает расположение объявлений по городу и области.

```{r}
library("tidyverse")
library("leaflet")

data %>%
  leaflet() %>%
  addProviderTiles(providers$OpenStreetMap.HOT, group = "OpenStreet") %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik, group = "Mapnik") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "World Imagery") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addLayersControl(baseGroups = c("Open Street", "Mapnik", "Toner Lite", "World Imagery")) %>%
  addMarkers(label=data$Price * 1000,
    clusterOptions = markerClusterOptions(),
    popup = paste("Цена/мес.: ", data$Price, 'тыс. ₽,', 
            " Площадь: ", data$Area_total, " м2")) %>%
  setView(lat = 59.85, lng = 30.50, zoom = 8.5) %>%
  addMiniMap(
    toggleDisplay = TRUE,
    tiles = providers$OpenStreetMap
  )
```
